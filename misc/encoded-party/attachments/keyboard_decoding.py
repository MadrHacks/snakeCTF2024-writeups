#!/usr/bin/env python3

from scapy.all import *
from scapy.layers.usb import *
shift_map = {
  'a' : 'A',
  'b' : 'B',
  'c' : 'C',
  'd' : 'D',
  'e' : 'E',
  'f' : 'F',
  'g' : 'G',
  'h' : 'H',
  'i' : 'I',
  'j' : 'J',
  'k' : 'K',
  'l' : 'L',
  'm' : 'M',
  'n' : 'N',
  'o' : 'O',
  'p' : 'P',
  'q' : 'Q',
  'r' : 'R',
  's' : 'S',
  't' : 'T',
  'u' : 'U',
  'v' : 'V',
  'w' : 'W',
  'x' : 'X',
  'y' : 'Y',
  'z' : 'Z',
  # numbers
  '1' : '!',
  '2' : '@',
  '3' : '#',
  '4' : '$',
  '5' : '%',
  '6' : '^',
  '7' : '&',
  '8' : '*',
  '9' : '(',
  '0' : ')',
  # symbols
  '-' : '_',
  '=' : '+',
  '[' : '{',
  ']' : '}',
  '\\' : '|',
  ';' : ':',
  '\'' : '"',
  ',' : '<',
  '.' : '>',
  '/' : '?',
  '`' : '~',
  ''  : ''
}
base_keys = {
  # meta
  b'\x00' : '', # none
  b'\x01' : 'error_ovf',
  # letters
  b'\x04' : 'a',
  b'\x05' : 'b',
  b'\x06' : 'c',
  b'\x07' : 'd',
  b'\x08' : 'e',
  b'\x09' : 'f',
  b'\x0a' : 'g',
  b'\x0b' : 'h',
  b'\x0c' : 'i',
  b'\x0d' : 'j',
  b'\x0e' : 'k',
  b'\x0f' : 'l',
  b'\x10' : 'm',
  b'\x11' : 'n',
  b'\x12' : 'o',
  b'\x13' : 'p',
  b'\x14' : 'q',
  b'\x15' : 'r',
  b'\x16' : 's',
  b'\x17' : 't',
  b'\x18' : 'u',
  b'\x19' : 'v',
  b'\x1a' : 'w',
  b'\x1b' : 'x',
  b'\x1c' : 'y',
  b'\x1d' : 'z',
  # numbers
  b'\x1e' : '1',
  b'\x1f' : '2',
  b'\x20' : '3',
  b'\x21' : '4',
  b'\x22' : '5',
  b'\x23' : '6',
  b'\x24' : '7',
  b'\x25' : '8',
  b'\x26' : '9',
  b'\x27' : '0',
  # misc
  b'\x28' : '\n',
  b'\x29' : 'esc',
  b'\x2a' : 'backspace',
  b'\x2b' : '\t',
  b'\x2c' : ' ',
  b'\x2d' : '-',
  b'\x2e' : '=',
  b'\x2f' : '[',
  b'\x30' : ']',
  b'\x31' : '\\',
  b'\x32' : '=',
  b'\x33' : ';',
  b'\x34' : '\'',
  b'\x35' : '`',
  b'\x36' : ',',
  b'\x37' : '.',
  b'\x38' : '/',
  b'\x39' : 'KEY_CAPSLOCK',
  b'\x3a' : 'KEY_F1',
  b'\x3b' : 'KEY_F2',
  b'\x3c' : 'KEY_F3',
  b'\x3d' : 'KEY_F4',
  b'\x3e' : 'KEY_F5',
  b'\x3f' : 'KEY_F6',
  b'\x40' : 'KEY_F7',
  b'\x41' : 'KEY_F8',
  b'\x42' : 'KEY_F9',
  b'\x43' : 'KEY_F10',
  b'\x44' : 'KEY_F11',
  b'\x45' : 'KEY_F12',
  b'\x46' : 'KEY_SYSRQ',
  b'\x47' : 'KEY_SCROLLLOCK',
  b'\x48' : 'KEY_PAUSE',
  b'\x49' : 'KEY_INSERT',
  b'\x4a' : 'KEY_HOME',
  b'\x4b' : 'KEY_PAGEUP',
  b'\x4c' : 'KEY_DELETE',
  b'\x4d' : 'KEY_END',
  b'\x4e' : 'KEY_PAGEDOWN',
  b'\x4f' : 'KEY_RIGHT',
  b'\x50' : 'KEY_LEFT',
  b'\x51' : 'KEY_DOWN',
  b'\x52' : 'KEY_UP',
  b'\x53' : 'KEY_NUMLOCK',
  b'\x54' : 'KEY_KPSLASH',
  b'\x55' : 'KEY_KPASTERISK',
  b'\x56' : 'KEY_KPMINUS',
  b'\x57' : 'KEY_KPPLUS',
  b'\x58' : 'KEY_KPENTER',
  b'\x59' : 'KEY_KP1',
  b'\x5a' : 'KEY_KP2',
  b'\x5b' : 'KEY_KP3',
  b'\x5c' : 'KEY_KP4',
  b'\x5d' : 'KEY_KP5',
  b'\x5e' : 'KEY_KP6',
  b'\x5f' : 'KEY_KP7',
  b'\x60' : 'KEY_KP8',
  b'\x61' : 'KEY_KP9',
  b'\x62' : 'KEY_KP0',
  b'\x63' : 'KEY_KPDOT',
  b'\x64' : 'KEY_102ND',
  b'\x65' : 'KEY_COMPOSE',
  b'\x66' : 'KEY_POWER',
  b'\x67' : 'KEY_KPEQUAL',
  b'\x68' : 'KEY_F13',
  b'\x69' : 'KEY_F14',
  b'\x6a' : 'KEY_F15',
  b'\x6b' : 'KEY_F16',
  b'\x6c' : 'KEY_F17',
  b'\x6d' : 'KEY_F18',
  b'\x6e' : 'KEY_F19',
  b'\x6f' : 'KEY_F20',
  b'\x70' : 'KEY_F21',
  b'\x71' : 'KEY_F22',
  b'\x72' : 'KEY_F23',
  b'\x73' : 'KEY_F24',
  b'\x74' : 'KEY_OPEN',
  b'\x75' : 'KEY_HELP',
  b'\x76' : 'KEY_PROPS',
  b'\x77' : 'KEY_FRONT',
  b'\x78' : 'KEY_STOP',
  b'\x79' : 'KEY_AGAIN',
  b'\x7a' : 'KEY_UNDO',
  b'\x7b' : 'KEY_CUT',
  b'\x7c' : 'KEY_COPY',
  b'\x7d' : 'KEY_PASTE',
  b'\x7e' : 'KEY_FIND',
  b'\x7f' : 'KEY_MUTE',
  b'\x80' : 'KEY_VOLUMEUP',
  b'\x81' : 'KEY_VOLUMEDOWN',
  b'\x85' : 'KEY_KPCOMMA',
  b'\x87' : 'KEY_RO',
  b'\x88' : 'KEY_KATAKANAHIRAGANA',
  b'\x89' : 'KEY_YEN',
  b'\x8a' : 'KEY_HENKAN',
  b'\x8b' : 'KEY_MUHENKAN',
  b'\x8c' : 'KEY_KPJPCOMMA',
  b'\x90' : 'KEY_HANGEUL',
  b'\x91' : 'KEY_HANJA',
  b'\x92' : 'KEY_KATAKANA',
  b'\x93' : 'KEY_HIRAGANA',
  b'\x94' : 'KEY_ZENKAKUHANKAKU',
  b'\xb6' : 'KEY_KPLEFTPAREN',
  b'\xb7' : 'KEY_KPRIGHTPAREN',
  b'\xe0' : 'KEY_LEFTCTRL',
  b'\xe1' : 'KEY_LEFTSHIFT',
  b'\xe2' : 'KEY_LEFTALT',
  b'\xe3' : 'KEY_LEFTMETA',
  b'\xe4' : 'KEY_RIGHTCTRL',
  b'\xe5' : 'KEY_RIGHTSHIFT',
  b'\xe6' : 'KEY_RIGHTALT',
  b'\xe7' : 'KEY_RIGHTMETA',
  b'\xe8' : 'KEY_MEDIA_PLAYPAUSE',
  b'\xe9' : 'KEY_MEDIA_STOPCD',
  b'\xea' : 'KEY_MEDIA_PREVIOUSSONG',
  b'\xeb' : 'KEY_MEDIA_NEXTSONG',
  b'\xec' : 'KEY_MEDIA_EJECTCD',
  b'\xed' : 'KEY_MEDIA_VOLUMEUP',
  b'\xee' : 'KEY_MEDIA_VOLUMEDOWN',
  b'\xef' : 'KEY_MEDIA_MUTE',
  b'\xf0' : 'KEY_MEDIA_WWW',
  b'\xf1' : 'KEY_MEDIA_BACK',
  b'\xf2' : 'KEY_MEDIA_FORWARD',
  b'\xf3' : 'KEY_MEDIA_STOP',
  b'\xf4' : 'KEY_MEDIA_FIND',
  b'\xf5' : 'KEY_MEDIA_SCROLLUP',
  b'\xf6' : 'KEY_MEDIA_SCROLLDOWN',
  b'\xf7' : 'KEY_MEDIA_EDIT',
  b'\xf8' : 'KEY_MEDIA_SLEEP',
  b'\xf9' : 'KEY_MEDIA_COFFEE',
  b'\xfa' : 'KEY_MEDIA_REFRESH',
  b'\xfb' : 'KEY_MEDIA_CALC'
}

pcap = PcapReader("party_info.pcap")
flag_base32 = ''
pkt_n = 0
dictionary = ''

for pkt in pcap:
    pkt_n += 1
    if pkt.haslayer(USBpcap):
        if pkt_n >= 119 and pkt_n <= 4472 and pkt[USBpcap].dataLength > 0:
            if pkt[USBpcap].load[1:2] == b'\x02' or pkt[USBpcap].load[1:2] == b'\x20': # Left or Right shift pressed
                dictionary += shift_map[base_keys[pkt[USBpcap].load[3:4]]]
            else:
                dictionary += base_keys[pkt[USBpcap].load[3:4]]
print(dictionary)
